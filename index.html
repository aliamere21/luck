<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø­Ø¸ Ø§Ù„ÙƒØ¨Ø±Ù‰ ğŸ”®</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Fonts for Arabic and digital look -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        body {
            background: radial-gradient(ellipse at top left, #232946 70%, #151b2c 100%);
            font-family: 'Cairo', Tahoma, Arial, sans-serif;
            color: #f4faff;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        .container, .admin-panel {
            max-width: 420px;
            margin: 36px auto 0 auto;
            background: rgba(35,41,70,0.98);
            border-radius: 20px;
            box-shadow: 0 6px 36px 0 #000b;
            padding: 35px 24px 26px 24px;
        }
        .container {
            margin-top: 40px;
            text-align: center;
        }
        h2 {
            color: #00ffd0;
            font-family: 'Share Tech Mono', monospace;
            letter-spacing: 2px;
            margin: 0 0 22px 0;
            font-size: 2.1em;
            text-shadow: 0 2px 12px #00ffd088;
        }
        .user-info {
            background: #1b2232;
            border-radius: 10px;
            padding: 10px 13px 6px 13px;
            margin: 0 0 24px 0;
            color: #ffe066;
            font-size: 1.08em;
            text-align: right;
        }
        .game-box {
            margin-bottom: 38px;
        }
        .luck-wheel {
            margin: 0 auto 18px auto;
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: conic-gradient(
                #ffe066 0 30deg,
                #00ffd0 30deg 90deg,
                #ff2255 90deg 150deg,
                #a0f 150deg 210deg,
                #00ffd0 210deg 270deg,
                #ffe066 270deg 330deg,
                #ff2255 330deg 360deg
            );
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 0 32px #00ffd0aa, 0 8px 30px #0009;
        }
        .wheel-pointer {
            position: absolute;
            top: -24px;
            left: 50%;
            transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 18px solid transparent;
            border-right: 18px solid transparent;
            border-bottom: 28px solid #ffe066;
            z-index: 10;
            filter: drop-shadow(0 2px 7px #ffe06677);
        }
        .wheel-btn {
            font-family: 'Share Tech Mono', Cairo, monospace;
            font-size: 1.15em;
            background: linear-gradient(90deg, #00ffd0, #ffe066);
            color: #232946;
            font-weight: bold;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            margin: 13px 0 0 0;
            padding: 12px 44px;
            box-shadow: 0 2px 12px #00ffd055;
            transition: transform 0.1s;
        }
        .wheel-btn:active {
            transform: scale(0.97);
        }
        .game-result {
            font-size: 1.2em;
            font-weight: bold;
            min-height: 34px;
            margin-top: 12px;
            color: #ffe066;
            text-shadow: 0 2px 8px #151b2c88;
        }
        .attempts-info {
            margin-top: 16px;
            color: #00ffd0;
            font-size: 1.08em;
        }
        .howto {
            margin-top: 14px;
            color: #ffe066c2;
            font-size: 0.99rem;
            line-height: 1.55;
            text-align: right;
            border-top: 1px dashed #00ffd055;
            padding-top: 8px;
        }
        /* Admin panel */
        .admin-panel {
            margin-top: 40px;
            display: none;
        }
        .admin-panel.active {
            display: block;
            animation: fadein 0.7s;
        }
        @keyframes fadein {
            from { opacity: 0; transform: translateY(30px);}
            to { opacity: 1;}
        }
        .admin-panel h3 {
            color: #ffe066;
            margin-bottom: 16px;
            letter-spacing: 1px;
        }
        .admin-panel input, .admin-panel button {
            font-size: 1.06rem;
            padding: 7px 13px;
            margin: 4px 0;
            border-radius: 7px;
            border: none;
            outline: none;
        }
        .admin-panel input {
            width: 44%;
            margin-left: 6px;
        }
        .admin-panel button {
            background: linear-gradient(90deg, #00ffd0, #ffe066);
            color: #232946;
            font-weight: bold;
            cursor: pointer;
            margin: 7px 2px;
            border-bottom: 2.5px solid #ffe066aa;
        }
        .msg {
            margin: 12px 0 0 0;
            font-size: 1.09em;
            color: #ffe066;
        }
        .users-list {
            margin-top: 18px;
            max-height: 340px;
            overflow-y: auto;
            background: #171d2f;
            border-radius: 8px;
            padding: 8px 4px;
        }
        table {
            width: 100%;
            background: #151b2c;
            border-radius: 10px;
            border-collapse: collapse;
            font-size: 0.99em;
        }
        th, td {
            padding: 7px 5px;
            text-align: center;
        }
        th {
            background: #232946;
            color: #ffe066;
            font-weight: bold;
            letter-spacing: 1px;
        }
        tr:nth-child(even) { background: #23294644;}
        tr:hover { background: #23294666;}
        .admin-actions button {
            font-size: 0.95em;
            padding: 5px 12px;
            margin: 0 2px;
        }
        .search-bar {
            margin: 10px 0 8px 0;
            display: flex;
            justify-content: flex-end;
        }
        .search-bar input {
            width: 54%;
            font-size: 1em;
            background: #232946;
            color: #00ffd0;
            border: 1.5px solid #00ffd066;
        }
        .admin-panel .logout-btn {
            background: #ff2255;
            color: #fff;
            margin: 5px 0 12px 0;
            border-radius: 6px;
            padding: 7px 24px;
            font-size: 1.04em;
        }
        .badge {
            display: inline-block;
            background: #00ffd080;
            color: #232946;
            font-size: 0.85em;
            border-radius: 8px;
            padding: 1px 10px 0 10px;
            margin-right: 2px;
            font-family: 'Cairo', sans-serif;
        }
        .badge.admin { background: #ffe066b0; color: #232946; }
        .badge.lucky { background: #ff2255c0; color: #fff; }
        .badge.active { background: #00ffd0c0; color: #232946;}
        .wheel-spin-anim {
            animation: spin 2.3s cubic-bezier(.22,.99,.46,1.01) 1;
        }
        @keyframes spin {
            0% { transform: rotate(0deg);}
            80% { transform: rotate(1100deg);}
            100% { transform: rotate(var(--angle,1100deg));}
        }
    </style>
</head>
<body>
<div class="container" id="gameContainer">
    <h2>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø­Ø¸ Ø§Ù„ÙƒØ¨Ø±Ù‰ ğŸ”®</h2>
    <div class="user-info" id="userInfo"></div>
    <div class="game-box">
        <div class="luck-wheel" id="luckWheel">
            <div class="wheel-pointer"></div>
            <span id="wheelCenter" style="font-family:'Share Tech Mono',monospace;font-size:2.3em;color:#232946;z-index:2;">?</span>
        </div>
        <button class="wheel-btn" onclick="spinWheel()" id="playBtn">Ø¬Ø±Ø¨ Ø­Ø¸Ùƒ Ø§Ù„Ø¢Ù†!</button>
        <div class="game-result" id="gameResult"></div>
    </div>
    <div class="attempts-info" id="attemptsInfo"></div>
    <div class="howto">
        â­ Ù„Ø¯ÙŠÙƒ Ù…Ø­Ø§ÙˆÙ„Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙŠÙˆÙ…ÙŠÙ‹Ø§.<br>
        ğŸ¯ Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Øª Ù…Ø­Ø§ÙˆÙ„ØªÙƒØŒ Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù† Ø£Ù† ÙŠØ±Ø¬Ø¹Ù‡Ø§.<br>
        ğŸŒ€ Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ø§Ù„Ø¯ÙˆØ±Ø§Ù†ØŒ Ù‚Ø¯ ØªØ±Ø¨Ø­ Ø¬Ø§Ø¦Ø²Ø© Ø£Ùˆ Ø±Ø³Ø§Ù„Ø© Ø³Ø±ÙŠØ©!<br>
        ğŸ›¡ï¸ Ù…Ø¹Ø±ÙÙƒ Ù…Ø­ÙÙˆØ¸ ÙˆÙ„Ù† ÙŠØ³ØªØ·ÙŠØ¹ ØºÙŠØ±Ùƒ Ø§Ù„Ù„Ø¹Ø¨ Ø¨Ù†ÙØ³ Ø§Ù„Ø­Ø³Ø§Ø¨.<br>
        <b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> ÙƒÙ„ Ù…Ø­Ø§ÙˆÙ„Ø§ØªÙƒ ØªØ³Ø¬Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….<br>
    </div>
</div>

<div class="admin-panel" id="adminPanel">
    <h3>ğŸ‘‘ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†</h3>
    <button class="logout-btn" onclick="logoutAdmin()">Ø®Ø±ÙˆØ¬ Ø§Ù„Ø£Ø¯Ù…Ù†</button>
    <div class="search-bar">
        <input type="text" id="searchUser" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…..." oninput="refreshUsers()">
    </div>
    <form id="userForm" onsubmit="return false;">
        <input type="text" id="adminUserId" placeholder="Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (userId)">
        <input type="number" min="0" id="attemptsInput" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª">
        <button onclick="setAttempts()">ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</button>
        <button onclick="restoreAttempt()">Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø© (1)</button>
        <button onclick="resetAttempts()">ØªØµÙÙŠØ± Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª (0)</button>
    </form>
    <div class="msg" id="msg"></div>
    <div class="users-list" id="usersList"></div>
</div>

<script>
// ========== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ==========
const ADMIN_TELEGRAM_USERNAME = "u_bil";  // ØºÙŠØ± Ù‡Ø°Ø§ Ù„ÙŠÙˆØ²Ø± Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙŠ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
const ADMIN_SECRET = "admin-super-2024"; // ØºÙŠØ± Ù‡Ø°Ø§ Ù„Ø±Ù…Ø² Ø±Ø§Ø¨Ø· Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø®Ø§Øµ

// ========== Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ==========
function getAllUsers() {
    let users = localStorage.getItem("luckGameUsers");
    users = users ? JSON.parse(users) : {};
    return users;
}
function saveAllUsers(users) {
    localStorage.setItem("luckGameUsers", JSON.stringify(users));
}
function getUser(userId) {
    let users = getAllUsers();
    return users[userId] || null;
}
function setUser(userId, attempts, displayName="", isAdmin=false) {
    let users = getAllUsers();
    users[userId] = users[userId] || {};
    users[userId].attempts = attempts;
    if (displayName) users[userId].displayName = displayName;
    if (isAdmin!==undefined) users[userId].isAdmin = !!isAdmin;
    if (!users[userId].joinedAt) users[userId].joinedAt = new Date().toISOString();
    saveAllUsers(users);
}
function setUserAttempts(userId, attempts) {
    let users = getAllUsers();
    let user = users[userId] || {};
    user.attempts = attempts;
    users[userId] = user;
    saveAllUsers(users);
}
function resetUserAttempts(userId) { setUserAttempts(userId, 0); }
function restoreUserAttempt(userId) { setUserAttempts(userId, 1); }
function deleteUser(userId) {
    let users = getAllUsers();
    delete users[userId];
    saveAllUsers(users);
}

// ========== Ø¬Ù„Ø¨ ÙŠÙˆØ²Ø± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠ ==========
let CURRENT_USER_ID = "";
let IS_ADMIN = false;
let CURRENT_USER_NAME_DISPLAY = "";
let CURRENT_USER_FULLNAME = "";
let isWebAppTelegram = false;

if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
    isWebAppTelegram = true;
    const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
    if (tgUser.username) {
        CURRENT_USER_ID = tgUser.username;
        CURRENT_USER_NAME_DISPLAY = "@" + tgUser.username;
    } else {
        CURRENT_USER_ID = "tg_" + tgUser.id;
        CURRENT_USER_NAME_DISPLAY = "ID: " + tgUser.id;
    }
    CURRENT_USER_FULLNAME = (tgUser.first_name||"") + (tgUser.last_name ? " " + tgUser.last_name : "");
    IS_ADMIN = (tgUser.username && tgUser.username.toLowerCase() === ADMIN_TELEGRAM_USERNAME.toLowerCase());
} else {
    // Ø®Ø§Ø±Ø¬ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… (Ù„Ù„ØªØ¬Ø±Ø¨Ø© ÙÙ‚Ø·)
    CURRENT_USER_ID = localStorage.getItem("currentUserId");
    if (!CURRENT_USER_ID) {
        CURRENT_USER_ID = prompt("Ø£Ø¯Ø®Ù„ ÙŠÙˆØ²Ø±Ùƒ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… (username ÙÙ‚Ø·):", "user_" + Math.floor(Math.random()*10000));
        localStorage.setItem("currentUserId", CURRENT_USER_ID);
    }
    CURRENT_USER_NAME_DISPLAY = CURRENT_USER_ID;
    CURRENT_USER_FULLNAME = CURRENT_USER_ID;
    IS_ADMIN = (CURRENT_USER_ID.toLowerCase() === ADMIN_TELEGRAM_USERNAME.toLowerCase());
}

// ========== Ø­Ù…Ø§ÙŠØ© ØµÙØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† ==========
function showAdminPanel() {
    document.getElementById('adminPanel').classList.add('active');
    document.getElementById('gameContainer').style.display = "none";
    refreshUsers();
}
function hideAdminPanel() {
    document.getElementById('adminPanel').classList.remove('active');
    document.getElementById('gameContainer').style.display = "block";
}
function logoutAdmin() {
    window.location.hash = "";
    hideAdminPanel();
}

// ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† Ø¥Ù…Ø§ Ø¨Ø±Ø§Ø¨Ø· Ø³Ø±ÙŠ Ø£Ùˆ Ø¥Ø°Ø§ Ù‡Ùˆ ÙŠÙˆØ²Ø± Ø§Ù„Ø£Ø¯Ù…Ù†
if (window.location.hash === "#"+ADMIN_SECRET || IS_ADMIN) {
    showAdminPanel();
} else {
    hideAdminPanel();
}

// ========== Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ==========
function displayUserInfo() {
    let el = document.getElementById('userInfo');
    let badges = "";
    if (IS_ADMIN) badges += `<span class="badge admin">Ø£Ø¯Ù…Ù†</span>`;
    el.innerHTML = `<b>Ù…Ø¹Ø±ÙÙƒ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…:</b> <span style="color:#00ffd0">${CURRENT_USER_NAME_DISPLAY}</span>
        ${CURRENT_USER_FULLNAME && CURRENT_USER_FULLNAME !== CURRENT_USER_ID ? "<br><b>Ø§Ù„Ø§Ø³Ù…:</b> "+CURRENT_USER_FULLNAME : ""}
        ${badges}`;
}
displayUserInfo();

// ========== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠ ==========
function autoRegisterUser() {
    let user = getUser(CURRENT_USER_ID);
    if (!user) {
        setUser(CURRENT_USER_ID, 1, CURRENT_USER_FULLNAME || CURRENT_USER_ID, IS_ADMIN);
    }
}
autoRegisterUser();
updateAttemptsOnScreen();

// ========== Ù„Ø¹Ø¨Ø© Ø§Ù„Ø­Ø¸ ==========
const wheelSectors = [
    { name: "Ù…Ø¨Ø±ÙˆÙƒ! ğŸ‰ ÙƒØ³Ø¨Øª 10 Ù†Ù‚Ø§Ø·", color: "#ffe066", type: "win", prize: 10 },
    { name: "Ø­Ø¸ Ø£ÙˆÙØ±! ğŸ˜…", color: "#00ffd0", type: "lose", prize: 0 },
    { name: "Ø¬Ø§Ø¦Ø²Ø© Ø³Ø±ÙŠØ©! ğŸ•µï¸", color: "#ff2255", type: "secret", prize: "ÙƒÙˆØ¯ Ø®Ø§Øµ" },
    { name: "Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø©! ğŸ”„", color: "#a0f", type: "retry", prize: "retry" },
    { name: "Ù…Ø¨Ø±ÙˆÙƒ! ğŸ ÙƒØ±Øª Ù‡Ø¯ÙŠØ©", color: "#00ffd0", type: "win", prize: "giftcard" },
    { name: "Ø­Ø¸ Ø£ÙˆÙØ±! ğŸ˜…", color: "#ffe066", type: "lose", prize: 0 },
    { name: "Ù…Ø¨Ø±ÙˆÙƒ! â­ Ù†Ø¬Ù…Ø©", color: "#ff2255", type: "win", prize: "star" },
    { name: "Ø­Ø¸ Ø£ÙˆÙØ±! ğŸ˜…", color: "#a0f", type: "lose", prize: 0 }
];
let isSpinning = false;

function spinWheel() {
    if (isSpinning) return;
    let user = getUser(CURRENT_USER_ID);
    if (!user || user.attempts <= 0) {
        showStatus("âŒ Ø§Ù†ØªÙ‡Øª Ù…Ø­Ø§ÙˆÙ„ØªÙƒ! Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù† Ø¥Ø±Ø¬Ø§Ø¹Ù‡Ø§.", true);
        return;
    }
    isSpinning = true;
    document.getElementById('playBtn').disabled = true;
    showStatus("Ø§Ù„Ø¯ÙˆÙ„Ø§Ø¨ ÙŠØ¯ÙˆØ±...", false);
    // Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ
    const sectorIdx = Math.floor(Math.random()*wheelSectors.length);
    const sector = wheelSectors[sectorIdx];
    // Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ø¯ÙˆÙ„Ø§Ø¨
    let fullRounds = 3;
    let degPerSector = 360 / wheelSectors.length;
    let angle = 360*fullRounds + (wheelSectors.length - sectorIdx - 0.5)*degPerSector;
    let wheel = document.getElementById('luckWheel');
    wheel.style.setProperty('--angle', angle + "deg");
    wheel.classList.remove('wheel-spin-anim');
    setTimeout(()=>{ wheel.classList.add('wheel-spin-anim'); }, 50);

    setTimeout(()=>{
        // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        document.getElementById('wheelCenter').textContent = "?";
        let msg = "";
        if (sector.type === "win") {
            msg = "ğŸ‰ " + sector.name;
        } else if (sector.type === "lose") {
            msg = "ğŸ˜… " + sector.name;
        } else if (sector.type === "secret") {
            msg = "ğŸ•µï¸ Ø¬Ø§Ø¦Ø²Ø© Ø³Ø±ÙŠØ©! ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø£Ø¯Ù…Ù†.";
        } else if (sector.type === "retry") {
            msg = "ğŸ”„ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙÙŠØ©!";
            setUserAttempts(CURRENT_USER_ID, user.attempts); // Ù„Ø§ ØªØ®ØµÙ… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
            updateAttemptsOnScreen();
        }
        document.getElementById('gameResult').textContent = msg;
        // Ø­ÙØ¸ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Ù† (Ù…Ø«Ù„Ø§Ù‹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø§Ø­Ù‚Ø§Ù‹)
        if (sector.type !== "retry") {
            setUserAttempts(CURRENT_USER_ID, user.attempts - 1);
            updateAttemptsOnScreen();
        }
        // ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ø­Ø¸ Ø³Ø¹ÙŠØ¯ Ø¥Ø°Ø§ Ø±Ø¨Ø­
        if (sector.type === "win" || sector.type === "secret") {
            let users = getAllUsers();
            users[CURRENT_USER_ID].lucky = true;
            saveAllUsers(users);
        }
        isSpinning = false;
        document.getElementById('playBtn').disabled = false;
        document.getElementById('wheelCenter').textContent = sectorIdx+1;
    }, 2450);
}

function showStatus(msg, isErr) {
    let el = document.getElementById('gameResult');
    el.textContent = msg;
    el.style.color = isErr ? "#ff2255" : "#ffe066";
}
function updateAttemptsOnScreen() {
    let user = getUser(CURRENT_USER_ID);
    document.getElementById('attemptsInfo').innerHTML =
        user ? `Ù…Ø­Ø§ÙˆÙ„Ø§ØªÙƒ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: <span style="color:#ffe066;font-weight:bold">${user.attempts}</span>` : "";
}

// ========== ADMIN PANEL ==========
function setAttempts() {
    let userId = document.getElementById('adminUserId').value.trim();
    let val = Number(document.getElementById('attemptsInput').value);
    if (!userId || isNaN(val) || val < 0) {
        showMsg("Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù ÙˆØ¹Ø¯Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØµØ­ÙŠØ­.");
        return false;
    }
    let user = getUser(userId);
    if (!user) setUser(userId, val);
    else setUserAttempts(userId, val);
    showMsg("ØªÙ… ØªØ¹ÙŠÙŠÙ† " + val + " Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… " + userId);
    refreshUsers();
    return false;
}
function restoreAttempt() {
    let userId = document.getElementById('adminUserId').value.trim();
    let user = getUser(userId);
    if (!userId || !user) { showMsg("Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ù…Ø³ØªØ®Ø¯Ù… ØµØ­ÙŠØ­ Ù…ÙˆØ¬ÙˆØ¯!"); return false; }
    restoreUserAttempt(userId);
    showMsg("ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… " + userId);
    refreshUsers();
    return false;
}
function resetAttempts() {
    let userId = document.getElementById('adminUserId').value.trim();
    let user = getUser(userId);
    if (!userId || !user) { showMsg("Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ù…Ø³ØªØ®Ø¯Ù… ØµØ­ÙŠØ­ Ù…ÙˆØ¬ÙˆØ¯!"); return false; }
    resetUserAttempts(userId);
    showMsg("ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… " + userId);
    refreshUsers();
    return false;
}
function showMsg(msg) {
    let el = document.getElementById('msg');
    el.textContent = msg;
    setTimeout(()=>{el.textContent=''}, 3200);
}
function refreshUsers() {
    let users = getAllUsers();
    let search = document.getElementById('searchUser')?.value?.trim()||"";
    let html = "<h3>ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</h3>";
    let keys = Object.keys(users).concat([]);
    if (search) {
        keys = keys.filter(uid =>
            uid.toLowerCase().includes(search.toLowerCase()) ||
            (users[uid].displayName && users[uid].displayName.toLowerCase().includes(search.toLowerCase()))
        );
    }
    if (keys.length === 0) {
        html += "<div>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¹Ø¯.</div>";
    } else {
        html += `<table>
            <tr><th>Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ù…Ø­Ø§ÙˆÙ„Ø§Øª</th><th>Ù…Ù†Ø°</th><th>Ø´Ø§Ø±Ø§Øª</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>`;
        keys.sort((a,b)=>users[b].joinedAt?.localeCompare(users[a].joinedAt));
        keys.forEach(userId => {
            let user = users[userId];
            let badges = "";
            if (user.isAdmin) badges += `<span class="badge admin">Ø£Ø¯Ù…Ù†</span>`;
            if (user.lucky) badges += `<span class="badge lucky">Ù…Ø­Ø¸ÙˆØ¸</span>`;
            if (user.attempts>0) badges += `<span class="badge active">Ù†Ø´Ø·</span>`;
            html += `<tr>
                <td>${userId}</td>
                <td>${user.displayName||""}</td>
                <td>${user.attempts||0}</td>
                <td>${user.joinedAt ? timeAgo(user.joinedAt) : ""}</td>
                <td>${badges}</td>
                <td class="admin-actions">
                    <button onclick="restoreUserAttempt('${userId}');refreshUsers();">1 Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                    <button onclick="resetUserAttempts('${userId}');refreshUsers();">ØªØµÙÙŠØ±</button>
                    <button onclick="deleteUser('${userId}');refreshUsers();">Ø­Ø°Ù</button>
                </td>
            </tr>`;
        });
        html += "</table>";
    }
    document.getElementById('usersList').innerHTML = html;
}
window.restoreUserAttempt = restoreUserAttempt;
window.resetUserAttempts = resetUserAttempts;
window.deleteUser = deleteUser;
window.refreshUsers = refreshUsers;

// ========== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ==========
function timeAgo(dateStr) {
    let d = new Date(dateStr);
    let now = new Date();
    let diff = (now - d)/1000;
    if (diff < 60) return "Ø§Ù„Ø¢Ù†";
    let m = Math.floor(diff/60);
    if (m<60) return `${m} Ø¯Ù‚ÙŠÙ‚Ø©`;
    let h = Math.floor(m/60);
    if (h<24) return `${h} Ø³Ø§Ø¹Ø©`;
    let d2 = Math.floor(h/24);
    return `${d2} ÙŠÙˆÙ…`;
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¹Ù†Ø¯ Ø£ÙŠ Ø­Ø¯Ø«
document.getElementById('playBtn').addEventListener('click', updateAttemptsOnScreen);

// Ø¹Ù†Ø¯ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†ØŒ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
if (document.getElementById('adminPanel').classList.contains('active')) refreshUsers();

</script>
</body>
</html>
