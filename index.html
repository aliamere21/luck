<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>لعبة المحاولات + لوحة الأدمن</title>
    <style>
        body {
            background: #1a1a32;
            color: #f4faff;
            font-family: 'Cairo', Tahoma, Arial, sans-serif;
            margin: 0; padding: 0;
        }
        .container, .admin-panel {
            max-width: 500px;
            margin: 30px auto 0 auto;
            background: #232946;
            border-radius: 18px;
            box-shadow: 0 6px 32px #000a;
            padding: 26px 18px 22px 18px;
        }
        .container {
            margin-top: 15px;
        }
        h2, h3 {
            color: #00ffd0;
        }
        input, button, select {
            font-size: 1.05rem;
            padding: 7px 13px;
            margin: 4px 0;
            border-radius: 7px;
            border: none;
            outline: none;
        }
        input, select { width: 74%; }
        button {
            background: linear-gradient(90deg, #00ffd0, #ffe066);
            color: #232946;
            font-weight: bold;
            cursor: pointer;
            margin: 7px 2px;
            border-bottom: 2.5px solid #ffe066aa;
        }
        .users-list {
            margin-top: 18px;
        }
        table {
            width: 100%;
            background: #1a1a32;
            border-radius: 10px;
            margin-top: 8px;
            border-collapse: collapse;
        }
        th, td {
            padding: 7px 5px;
            text-align: center;
        }
        th {
            background: #232946;
            color: #ffe066;
        }
        tr:nth-child(even) { background: #23294644;}
        tr:hover { background: #23294666;}
        .admin-actions button {
            font-size: 0.95em;
            padding: 5px 12px;
            margin: 0 2px;
        }
        .msg {
            margin: 12px 0 0 0;
            font-size: 1.09em;
            color: #ffe066;
        }
        .code-col {
            font-family: "Consolas", "Cairo", monospace;
            color: #00ffd0;
            font-weight: bold;
            direction: ltr;
        }
    </style>
</head>
<body>
<div class="container">
    <h2>🎮 لعبة المحاولات</h2>
    <div>
        <input type="text" id="userId" placeholder="معرف المستخدم (userId)">
        <input type="text" id="userCode" placeholder="رمز المستخدم (Code)">
        <button onclick="checkAttempts()">ابدأ اللعب</button>
    </div>
    <div id="status" style="margin:17px 0 14px 0; font-size: 1.13rem; font-weight:bold"></div>
    <div style="margin-top:14px; color:#ffe066b3; font-size:0.99rem;">
        * كل مستخدم له محاولة واحدة + رمز.<br>
        * إذا انتهت محاولتك تصير 0.<br>
        * إذا وضع الأدمن المحاولة = 1 ترجع.<br>
        * لوحة الأدمن تتحكم بالمحاولات والرمز.<br>
        * المستخدم يضاف تلقائيًا عند أول دخول صحيح.<br>
    </div>
</div>
<div class="admin-panel">
    <h3>👑 لوحة تحكم الأدمن</h3>
    <form id="userForm" onsubmit="return false;">
        <input type="text" id="adminUserId" placeholder="معرف المستخدم (userId)">
        <input type="text" id="adminUserCode" placeholder="رمز المستخدم (Code)">
        <input type="number" min="0" id="attemptsInput" placeholder="عدد المحاولات">
        <button onclick="setAttempts()">تعيين المحاولات/رمز</button>
        <button onclick="restoreAttempt()">إرجاع محاولة (1)</button>
        <button onclick="resetAttempts()">تصفير المحاولات (0)</button>
    </form>
    <div class="msg" id="msg"></div>
    <div class="users-list" id="usersList"></div>
</div>
<script>
// ========== DATA STRUCTURE =========
// usersData = { userId: {code: ..., attempts: ...}, ... }
function getAllUsers() {
    let users = localStorage.getItem("gameAttemptsUsers");
    users = users ? JSON.parse(users) : {};
    return users;
}
function saveAllUsers(users) {
    localStorage.setItem("gameAttemptsUsers", JSON.stringify(users));
}
function getUser(userId) {
    let users = getAllUsers();
    return users[userId] || null;
}
function setUser(userId, code, attempts) {
    let users = getAllUsers();
    users[userId] = { code: code, attempts: attempts };
    saveAllUsers(users);
}
function setUserAttempts(userId, attempts) {
    let users = getAllUsers();
    let user = users[userId] || {code:'', attempts:1};
    user.attempts = attempts;
    users[userId] = user;
    saveAllUsers(users);
}
function setUserCode(userId, code) {
    let users = getAllUsers();
    let user = users[userId] || {code:'', attempts:1};
    user.code = code;
    users[userId] = user;
    saveAllUsers(users);
}
function resetUserAttempts(userId) {
    setUserAttempts(userId, 0);
}
function restoreUserAttempt(userId) {
    setUserAttempts(userId, 1);
}
function deleteUser(userId) {
    let users = getAllUsers();
    delete users[userId];
    saveAllUsers(users);
}

// ========== PLAYER SECTION ==========
function checkAttempts() {
    let userId = document.getElementById('userId').value.trim();
    let userCode = document.getElementById('userCode').value.trim();
    if (!userId || !userCode) {
        showStatus("رجاءً أدخل معرف المستخدم والرمز!", true);
        return;
    }
    let user = getUser(userId);

    // --- يضاف تلقائيا إذا لم يكن موجود ---
    if (!user) {
        setUser(userId, userCode, 1);
        user = { code: userCode, attempts: 1 };
        showStatus("🟢 تم تسجيلك بنجاح! لديك محاولة واحدة للعب.", false);
        refreshUsers();
        return;
    }
    // -------------------------------------

    // تحقق من الرمز
    if (user.code !== userCode) {
        showStatus("❌ رمز المستخدم غير صحيح!", true);
        return;
    }
    if (user.attempts > 0) {
        setUserAttempts(userId, user.attempts - 1);
        showStatus("✅ تستطيع اللعب! (المحاولة الآن: " + (user.attempts - 1) + ")", false);
        refreshUsers();
    } else {
        showStatus("❌ انتهت محاولتك! اطلب من الأدمن إرجاعها.", true);
    }
}
function showStatus(msg, isErr) {
    let el = document.getElementById('status');
    el.textContent = msg;
    el.style.color = isErr ? "#ff2255" : "#00ffd0";
}

// ========== ADMIN SECTION ==========
function setAttempts() {
    let userId = document.getElementById('adminUserId').value.trim();
    let userCode = document.getElementById('adminUserCode').value.trim();
    let val = Number(document.getElementById('attemptsInput').value);
    if (!userId || !userCode || isNaN(val) || val < 0) {
        showMsg("أدخل معرف، رمز وعدد محاولات صحيح.");
        return false;
    }
    setUser(userId, userCode, val);
    showMsg("تم تعيين " + val + " محاولة للمستخدم " + userId + " برمز ["+userCode+"]");
    refreshUsers();
    return false;
}
function restoreAttempt() {
    let userId = document.getElementById('adminUserId').value.trim();
    let user = getUser(userId);
    if (!userId || !user || !user.code) { showMsg("أدخل معرف مستخدم صحيح موجود!"); return false; }
    restoreUserAttempt(userId);
    showMsg("تم إرجاع محاولة واحدة للمستخدم " + userId);
    refreshUsers();
    return false;
}
function resetAttempts() {
    let userId = document.getElementById('adminUserId').value.trim();
    let user = getUser(userId);
    if (!userId || !user || !user.code) { showMsg("أدخل معرف مستخدم صحيح موجود!"); return false; }
    resetUserAttempts(userId);
    showMsg("تم تصفير المحاولات للمستخدم " + userId);
    refreshUsers();
    return false;
}
function showMsg(msg) {
    let el = document.getElementById('msg');
    el.textContent = msg;
    setTimeout(()=>{el.textContent=''}, 3200);
}
function refreshUsers() {
    let users = getAllUsers();
    let html = "<h3>كل المستخدمين المسجلين</h3>";
    let keys = Object.keys(users);
    if (keys.length === 0) {
        html += "<div>لا يوجد مستخدمين بعد.</div>";
    } else {
        html += `<table>
            <tr><th>معرف المستخدم</th><th>الرمز</th><th>عدد المحاولات</th><th>إجراءات</th></tr>`;
        keys.forEach(userId => {
            let user = users[userId];
            html += `<tr>
                <td>${userId}</td>
                <td class="code-col">${user.code}</td>
                <td>${user.attempts}</td>
                <td class="admin-actions">
                    <button onclick="restoreUserAttempt('${userId}');refreshUsers();">1 محاولة</button>
                    <button onclick="resetUserAttempts('${userId}');refreshUsers();">تصفير</button>
                    <button onclick="deleteUser('${userId}');refreshUsers();">حذف</button>
                </td>
            </tr>`;
        });
        html += "</table>";
    }
    document.getElementById('usersList').innerHTML = html;
}
window.restoreUserAttempt = restoreUserAttempt;
window.resetUserAttempts = resetUserAttempts;
window.deleteUser = deleteUser;
window.refreshUsers = refreshUsers;

document.addEventListener('DOMContentLoaded', refreshUsers);
</script>
</body>
</html>
